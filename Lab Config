Hyper-V Dual Adapter Homelab Network Configuration:

Domain: Shane.local

Firewalls must be disabled in guest OS of VMs or networking will not work properly

VMs:

Server	OS	Services	Hostname	IP Address
Windows Server 1	Windows Server 2019	DC 1 / DNS / DHCP	ShaneServer	192.168.1.100
Windows Server 2	Windows Server 2019	DC 2	ShaneServer2	192.168.1.101
Windows Server 3	Windows Server 2019	-	ShaneServer3	192.168.1.102
Windows Client	Windows 10 Pro	Client	ShaneClient	192.168.1.103
Linux Server1	CentOS	-	ShaneLinux	192.168.1.104
Linux Server2	CentOS	-	ShaneLinux2	192.168.1.105
NAS	TrueNAS	Network Storage	ShaneNAS	192.168.1.106
Firewall	pfSense	Firewall	ShaneFirewall	192.168.1.107

Host:

Static Switch is for internal communication - VM>VM: All Addresses are Static in Guest OS

Default Switch is for external communication - VM>WAN: All Addresses are Dynamic in Guest OS

Host Config	Type	IP	Configuration
"Static Switch"	Internal	192.168.1.10	New-NetIPAddress -InterfaceAlias "vEthernet (Static Switch)" -IPAddress 192.168.1.10 -PrefixLength "24"
"Default Switch"	Default	N/A	N/A - Address is Dynamic and changes with reboots

Azure AD Connect:

Azure AD Connect is running on ShaneServer. 

Credentials: ShaneAdmin@Shane-Hartley.com - Tenant ID: 2b0884e8-3366-4d15-9fb6-1971df9f4fc0

Windows Server 1:

Configuration
1. # Set DNS to Loopback Address
Set-DnsClientServerAddress -InterfaceAlias "Ethernet" -ServerAddresses "127.0.0.1"

2. # Set Static IP, and Gateway to Host Adapter IP
New-NetIPAddress -InterfaceAlias "Ethernet" -IPAddress 192.168.1.100 -PrefixLength "24" -DefaultGateway 192.168.1.10

3. # Disable Firewall
Set-NetFirewallProfile -Enabled False

4. # Disable IPv6
Disable-NetAdapterBinding -Name "Ethernet" -ComponentID ms_tcpip6

5. # Setting Hostname
Rename-Computer -NewName "ShaneServer"
Restart-Computer

6. # Update PowerShell Help
Update-Help

7. # Install ADDS and Management tools
Install-WindowsFeature -name AD-Domain-Services -IncludeManagementTools

8. # Test the configuration before installing the forest
Test-ADDSForestInstallation -DomainName shane.local -InstallDns

9. # Creating a new AD Forest with domain name Shane.local
Install-ADDSForest -DomainName shane.local -InstallDNS

10. # After reboot, check that AD is installed and Domain is configured
Get-ADDomainController

11. # Install PowerShell Version 7
Invoke-Expression "& { $(Invoke-RestMethod 'https://aka.ms/install-powershell.ps1') } -useMSI -Quiet -EnablePSRemoting"

12. # Install NuGet Package manager, prerequisite for installing modules
Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force

$Modules = @( 
"Az", 
"AzureAD", 
"MicrosoftTeams", 
"ExchangeOnlineManagement", 
"Microsoft.Online.SharePoint.PowerShell", 
"SharePointPnPPowerShellOnline", 
"Microsoft.Graph", 
"MSOnline" 
)

13. # Installing Modules
Install-Module -Name $Modules -Force

14. # Disable IE Enhanced Security 
function Disable-InternetExplorerESC {
      $AdminKey = "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A7-37EF-4b3f-8CFC-4F3A74704073}"
      $UserKey = "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A8-37EF-4b3f-8CFC-4F3A74704073}"
      Set-ItemProperty -Path $AdminKey -Name "IsInstalled" -Value 0 -Force
      Set-ItemProperty -Path $UserKey -Name "IsInstalled" -Value 0 -Force
      Rundll32 iesetup.dll, IEHardenLMSettings
      Rundll32 iesetup.dll, IEHardenUser
      Rundll32 iesetup.dll, IEHardenAdmin
      Write-Host "IE Enhanced Security Configuration (ESC) has been disabled."
 }
Disable-InternetExplorerEsc

15. # Setting Time Zone
Set-TimeZone -Name "Eastern Standard Time"

16. # Creating OU, Users, and Groups

# Creating OU ShaneUsers
New-ADOrganizationalUnit -Name "ShaneUsers"
$users = Get-ADOrganizationalUnit -LDAPFilter '(name=ShaneUsers)'
$users.DistinguishedName

# Setting passwords for accounts
$secpass = Read-Host "Set password for accounts" -AsSecureString

# Creating accounts

# Regular User Account
New-ADUser -UserPrincipalName "Shane@shane.local" -Path $users.DistinguishedName -PasswordNeverExpires $True -Name "Shane Hartley" -Enabled $True -AccountPassword ($secpass) -SamAccountName "Shane"

# Admin User Account
New-ADUser -UserPrincipalName "ShaneAdmin@shane.local" -Path $users.DistinguishedName -PasswordNeverExpires $True -Name "Shane Hartley" -Enabled $True -AccountPassword ($secpass) -SamAccountName "ShaneAdmin"

# Service Account
New-ADServiceAccount -Path $users.DistinguishedName -Name "ShaneService" -DNSHostName ShaneServer.shane.local

# Creating Security Group ShaneSG
New-ADGroup -Name "ShaneSG" -SamAccountName ShaneSG -GroupCategory Security -GroupScope Global -DisplayName "ShaneSG" -Path $users.DistinguishedName

# Adding admin user to default SGs 
Add-ADGroupMember -Identity "Domain Admins" -Members "ShaneAdmin"
Add-ADGroupMember -Identity "Server Operators" -Members "ShaneAdmin"

# Adding users created in the Shane OU to the Shane SG
Get-ADUser -filter * -searchbase $users.DistinguishedName | ForEach-Object {Add-AdGroupMember -Identity shaneSG -members $_.SamAccountName}

17. # Configuring DNS

# Add Forward Lookup Zone (Installation of ADDS will take care of this - leaving in lab for redundancy)
Add-DNSServerPrimaryZone -Name "shane.local" -ComputerName "ShaneServer" -ReplicationScope "Domain" -PassThru
Get-DNSServerZone -ZoneName "Shane.local"

# Add Reverse Lookup Zone (Installation of ADDS will take care of this - leaving in lab for redundancy)
Add-DNSServerPrimaryZone -NetworkID "192.168.1.0/24" -ComputerName "Shaneserver" -ReplicationScope "Domain" -PassThru

# Add General Forwarder - (Google - leaving in lab to translate anything no resolvable by internal DNS)
Add-DNSServerForwarder -IPAddress 8.8.8.8 -PassThru
Get-DNSServerForwarder 

# Add A Records
Add-DNSServerResourceRecordA -Name "<Shaneserver>" -ZoneName "Shane.local" -IPv4Address "<192.168.1.100>" -ComputerName "ShaneServer"
Add-DNSServerResourceRecordA -Name "<Shaneserver2>" -ZoneName "Shane.local" -IPv4Address "<192.168.1.101>" -ComputerName "ShaneServer"
Add-DNSServerResourceRecordA -Name "<Shaneserver3>" -ZoneName "Shane.local" -IPv4Address "<192.168.1.102>" -ComputerName "ShaneServer"
Add-DNSServerResourceRecordA -Name "<Shaneclient>" -ZoneName "Shane.local" -IPv4Address "<192.168.1.103>" -ComputerName "ShaneServer"
Add-DNSServerResourceRecordA -Name "<Shanelinux>" -ZoneName "Shane.local" -IPv4Address "<192.168.1.104>" -ComputerName "ShaneServer"
Add-DNSServerResourceRecordA -Name "<Shanelinux2>" -ZoneName "Shane.local" -IPv4Address "<192.168.1.105>" -ComputerName "ShaneServer"
Add-DNSServerResourceRecordA -Name "<Shanenas>" -ZoneName "Shane.local" -IPv4Address "<192.168.1.106>" -ComputerName "ShaneServer"
Add-DNSServerResourceRecordA -Name "<Shanefirewall>" -ZoneName "Shane.local" -IPv4Address "<192.168.1.107>" -ComputerName "ShaneServer"

# Add PTR Records
Add-DNSServerResourceRecordPtr -Name '100' -ZoneName '1.168.192.shane.local' -PtrDomainName 'Shaneserver.shane.local' -ComputerName "shaneserver"
Add-DNSServerResourceRecordPtr -Name '101' -ZoneName '1.168.192.shane.local' -PtrDomainName 'shaneserver2.shane.local' -ComputerName "shaneserver"
Add-DNSServerResourceRecordPtr -Name '102' -ZoneName '1.168.192.shane.local' -PtrDomainName 'shaneserver3.shane.local' -ComputerName "shaneserver"
Add-DNSServerResourceRecordPtr -Name '103' -ZoneName '1.168.192.shane.local' -PtrDomainName 'shaneclient.shane.local' -ComputerName "shaneserver"
Add-DNSServerResourceRecordPtr -Name '104' -ZoneName '1.168.192.shane.local' -PtrDomainName 'shanelinux.shane.local' -ComputerName "shaneserver"
Add-DNSServerResourceRecordPtr -Name '105' -ZoneName '1.168.192.shane.local' -PtrDomainName 'shanelinux2.shane.local' -ComputerName "shaneserver"
Add-DNSServerResourceRecordPtr -Name '106' -ZoneName '1.168.192.shane.local' -PtrDomainName 'shanenas.shane.local' -ComputerName "shaneserver"
Add-DNSServerResourceRecordPtr -Name '107' -ZoneName '1.168.192.shane.local' -PtrDomainName 'shanefirewall.shane.local' -ComputerName "shaneserver"

# Confirm DNS Records 
Get-DNSServerResourceRecord -ZoneName "<Zone>" -ComputerName <DNSServerName>

Windows Server 2:

Configuration
1. # Set DNS to Server 1
Set-DnsClientServerAddress -InterfaceAlias "Ethernet" -ServerAddresses "192.168.1.100"

2. # Set Static IP, and Gateway to Host Adapter IP
New-NetIPAddress -InterfaceAlias "Ethernet" -IPAddress 192.168.1.101 -PrefixLength "24" -DefaultGateway 192.168.1.10

3. # Disable firewall
Set-NetFirewallProfile -Enabled False

4. # Disable IPv6
Disable-NetAdapterBinding -Name "Ethernet" -ComponentID ms_tcpip6

5. # Setting Hostname
Rename-Computer -NewName "ShaneServer2"
Restart-Computer

6. # Update PowerShell Help
Update-Help

7. # Install ADDS and Management tools
Install-WindowsFeature -name AD-Domain-Services -IncludeManagementTools

8. # Join Server 2 to Domain
Install-ADDSDomainController -DomainName "shane.local" -Credential (Get-Credential "Shane\Administrator")

9. # Install PowerShell Version 7
Invoke-Expression "& { $(Invoke-RestMethod 'https://aka.ms/install-powershell.ps1') } -useMSI -Quiet -EnablePSRemoting"

10. # Install NuGet Package manager, prerequisite for installing modules
Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force

$Modules = @( 
"Az", 
"AzureAD", 
"MicrosoftTeams", 
"ExchangeOnlineManagement", 
"Microsoft.Online.SharePoint.PowerShell", 
"SharePointPnPPowerShellOnline", 
"Microsoft.Graph", 
"MSOnline" 
)

11. # Installing Modules
Install-Module -Name $Modules -Force

12. # Disable IE Enhanced Security 
function Disable-InternetExplorerESC {
      $AdminKey = "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A7-37EF-4b3f-8CFC-4F3A74704073}"
      $UserKey = "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A8-37EF-4b3f-8CFC-4F3A74704073}"
      Set-ItemProperty -Path $AdminKey -Name "IsInstalled" -Value 0 -Force
      Set-ItemProperty -Path $UserKey -Name "IsInstalled" -Value 0 -Force
      Rundll32 iesetup.dll, IEHardenLMSettings
      Rundll32 iesetup.dll, IEHardenUser
      Rundll32 iesetup.dll, IEHardenAdmin
      Write-Host "IE Enhanced Security Configuration (ESC) has been disabled."
 }
Disable-InternetExplorerEsc

13. # Setting Time Zone
Set-TimeZone -Name "Eastern Standard Time"

Windows Server 3:

Configuration
1. # Set DNS to Server 1
Set-DnsClientServerAddress -InterfaceAlias "Ethernet" -ServerAddresses "192.168.1.100"

2. # Set Static IP, and Gateway to Host Adapter IP
New-NetIPAddress -InterfaceAlias "Ethernet" -IPAddress 192.168.1.102 -PrefixLength "24" -DefaultGateway 192.168.1.10

3. # Disable firewall
Set-NetFirewallProfile -Enabled False

4. # Disable IPv6
Disable-NetAdapterBinding -Name "Ethernet" -ComponentID ms_tcpip6

5. # Setting Hostname
Rename-Computer -NewName "ShaneServer3"
Restart-Computer

6. # Update PowerShell Help
Update-Help

7. # Install PowerShell Version 7
Invoke-Expression "& { $(Invoke-RestMethod 'https://aka.ms/install-powershell.ps1') } -useMSI -Quiet -EnablePSRemoting"

8. # Install NuGet Package manager, prerequisite for installing modules
Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force

$Modules = @( 
"Az", 
"AzureAD", 
"MicrosoftTeams", 
"ExchangeOnlineManagement", 
"Microsoft.Online.SharePoint.PowerShell", 
"SharePointPnPPowerShellOnline", 
"Microsoft.Graph", 
"MSOnline" 
)

9. # Installing Modules
Install-Module -Name $Modules -Force

10. # Disable IE Enhanced Security 
function Disable-InternetExplorerESC {
      $AdminKey = "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A7-37EF-4b3f-8CFC-4F3A74704073}"
      $UserKey = "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A8-37EF-4b3f-8CFC-4F3A74704073}"
      Set-ItemProperty -Path $AdminKey -Name "IsInstalled" -Value 0 -Force
      Set-ItemProperty -Path $UserKey -Name "IsInstalled" -Value 0 -Force
      Rundll32 iesetup.dll, IEHardenLMSettings
      Rundll32 iesetup.dll, IEHardenUser
      Rundll32 iesetup.dll, IEHardenAdmin
      Write-Host "IE Enhanced Security Configuration (ESC) has been disabled."
 }
Disable-InternetExplorerEsc

11. # Setting Time Zone
Set-TimeZone -Name "Eastern Standard Time"

12. # Join the Server to the Domain 
Add-Computer -DomainCredential administrator -Server "Shaneserver" -DomainName "Shane.local"
Restart-Computer

13. # Configuring and Mapping Network share
Set-Location C:\
New-Item -Type Directory -Name ShaneShare
New-SmbShare -Path C:\ShaneShare -Name "ShaneShare"

# Creating a PS Session variable
$session = New-PSSession -ComputerName "shaneclient" -Credential(Get-Credential)

# Creating a mapping of shared drive on Shaneclient to move files between server and client
Invoke-command -Session $session -ScriptBlock {New-PSDrive -Name "S" -PSProvider "FileSystem" -Root "\\ShaneServer3\Shaneshare"}

Windows Client:

Configuration
1. # Set DNS to Server 1
Set-DnsClientServerAddress -InterfaceAlias "Ethernet" -ServerAddresses "192.168.1.100"

2. # Set Static IP, and Gateway to Host Adapter IP
New-NetIPAddress -InterfaceAlias "Ethernet" -IPAddress 192.168.1.103 -PrefixLength "24" -DefaultGateway 192.168.1.10

3. # Disable firewall
Set-NetFirewallProfile -Enabled False

4. # Disable IPv6
Disable-NetAdapterBinding -Name "Ethernet" -ComponentID ms_tcpip6

5. # Setting Hostname
Rename-Computer -NewName "ShaneClient"
Restart-Computer

6. # Update PowerShell Help
Update-Help

7. # Install PowerShell Version 7
Invoke-Expression "& { $(Invoke-RestMethod 'https://aka.ms/install-powershell.ps1') } -useMSI -Quiet -EnablePSRemoting"

8. # Install NuGet Package manager, prerequisite for installing modules
Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force

$Modules = @( 
"Az", 
"AzureAD", 
"MicrosoftTeams", 
"ExchangeOnlineManagement", 
"Microsoft.Online.SharePoint.PowerShell", 
"SharePointPnPPowerShellOnline", 
"Microsoft.Graph", 
"MSOnline" 
)

9. # Installing Modules
Install-Module -Name $Modules -Force

10. # Setting Time Zone
Set-TimeZone -Name "Eastern Standard Time"

11. # Join the Client to the Domain 
Add-Computer -DomainCredential administrator -Server "Shaneserver" -DomainName "Shane.local"
Restart-Computer

Linux Server 1:

Configuration


Linux Server 2:

Configuration


NAS:

Configuration
1. Create Separate Drive on Host for Storage

2. Create Drive Mapping N (N for NAS)

3. Boot Drive cannot be same Drive for Storage

4. Connect Hyper-V Static Switch
Interface Name: NASInterface
IP: 192.168.1.106
Subnet: 255.255.255.0

5. Connect Virtual Hard Disk to VM for Storage

6. Configure DNS
Domain: Shane
DNS Name Server 1: 192.168.1.100
DNS Name Server 2: N/A

7. Configure Default Route
IP: 192.168.1.10

Admin WebGUI Username/Password: See Bitwarden

8. In Guest OS:
Cd /mnt
Mkdir ShaneSMB

9. Create a new Pool
Storage -> Pools
Name: ShanePool

10. Create a SMB Share
Sharing -> Windows Shares (SMB)
Name: ShaneSMB

11. Create a new User
Accounts -> Users
Name: Shane

12. Edit ACL with Permissions

13. Map the SMB Share with Shane User Credentials

Firewall:

Configuration
1. Connect Hyper-V Default Switch

2. Configure WAN Interface for Default Switch: DHCP
WAN (VM -> WAN)

3. Connect Hyper-V Static Switch

4. Configure LAN Interface for Static Switch: Static IP
LAN (VM -> VM)
IP: 192.168.1.107 
Subnet: 255.255.255.0 
Gateway: 192.168.1.10 

Web Interface for pfSense Firewall
https://192.168.1.107

Hostname: ShaneFirewall
Domain: Shane.Local
Primary DNS Server: 192.168.1.100 (ShaneServer)
Time Server Hostname: 0.us.pool.ntp.org
Timezone: US/Eastern

Admin WebGUI Username/Password: See Bitwarden

